<link rel="import" href="../polymer/polymer.html">

<!--
Element providing solution to no problem in particular.

##### Example

    <p5-element></p5-element>

@element p5-element
@blurb Element providing solution to no problem in particular.
@status alpha
@homepage http://sepans.github.io/p5-element
-->
<polymer-element name="p5-element">

  <template>

    <link rel="stylesheet" href="p5-element.css" />

    <content></content>
    <div class="code">var </div>
    <textarea value="{{globalVars}}" class="setup-function code vars" placeholder="" rows="2">></textarea>
    <div class="code">;</div>
    <div class="error setupErr">{{displaySetupErr}}</div>
    <div class="code">function setup() {</div>
    <textarea value="{{setupFunction}}" class="setup-function code" placeholder="enter setup function" rows="4">></textarea>
    <div class="code">}</div>

    <div class="error drawErr">{{displayDrawErr}}</div>
    <div class="code">function draw() {</div>
    <textarea value="{{drawFunction}}" class="draw-function code" placeholder="enter draw function" rows="4">></textarea>
    <div class="code">}</div>


   
     <div id="canvas_container"></div>

    

  </template>
  <script src="../p5js/lib/p5.js"></script>

  <script>

    Polymer('p5-element', {
     
      _p5: null,
      _sketch: {},
      globalVars: 'x= 30, y = 15',
      setupFunction: 'createCanvas(200,200);\n background(255); \n rect(10,10,10,10);',
      drawFunction: ' background(255); \n rect(x,y,20,20); \n /* x++;  y++; */',
      displaySetupErr: '',
      displayDrawErr: '',
      observe: {
        setupFunction: '_setupFunctionChanged',
        drawFunction: '_drawFunctionChanged',
        globalVars: '_globalVarsChanged',
        setupErr: 'setupErrChanged',
        drawErr: 'drawErrChanged',
      },
      ready: function() {
        
       var self = this;
       self._globalVarsChanged();
       self._createP5();
      },

      _createP5: function() {
        var self = this,
            setupFunc = null,
            drawFunc = null;

        try {
          setupFunc = new Function('with (this) {'+self.setupFunction+'}'); 
        }
        catch(e) {
          self.setupErr = e.message;//  + ' ' + e.lineNumber;
          return;
        }
        self.setupErr = '';

        try {

          drawFunc = new Function('with (this) {'+self.drawFunction+'}'); 
        }
        catch(e) {
          self.drawErr = e.message;// + ' ' + e.lineNumber;
          return;
        }
        self.drawErr = '';

        console.log(self._globalVarsParsed);

        self._sketch = function(sketch) {

          // circular reference?
          self._globalVarsParsed.forEach(function(item) {
            console.log(item.name);
            sketch[item.name] = item.value;
          });

          sketch.setup =  setupFunc.bind(sketch);
          sketch.draw =  drawFunc.bind(sketch);
        }

        // self._globalVarsParsed.forEach(function(item) {
        //   self._sketch[item.name] = item.value;
        // });
        console.log('creating p5');
        console.log(self._sketch);

        try {
            self._p5 = new p5(self._sketch, self.$.canvas_container); 
        }
        catch(e) {
          console.log('error deleting p5');
          console.log(e.message);
          self.drawErr = e.message;// + ' ' + e.lineNumber;
          //self._p5.noLoop();
          self._p5.remove();
          //self._p5 = null;
          return;
        }

      },
      
      _setupFunctionChanged: function() {

        this._createP5();
        // var setupFunc = new Function(self.setupFunction); 
        // _p5._setup = setupFunc;

      },

      _drawFunctionChanged: function() {

        this._createP5();

        // var drawFunc = new Function(self.drawFunction); 
        // _p5._draw = drawFunc;

      },
      setupErrChanged: function() {
        
        var self = this;
        if(self.setupErr.length==0) {
          self.displaySetupErr = '';
          return;

        }

        clearTimeout(self._setupTimeOut);
        self._setupTimeOut = setTimeout(function() {
          if(self.setupErr.length>0) {
            self.displaySetupErr = self.setupErr;
          }

        }, 1000);
      },

      drawErrChanged: function() {
        
        var self = this;

        if(self.drawErr.length==0) {
          self.displayDrawErr = '';

          return;

        }

        clearTimeout(self._drawTimeOut);
        self._drawTimeOut = setTimeout(function() {
          if(self.drawErr.length>0) {
            self.displayDrawErr = self.drawErr;
          }

        }, 1500);
      },

      _globalVarsChanged: function() {
        var self = this;
        self._globalVarsParsed = [];
        var varList = self.globalVars.split(',');
        self._globalVarsParsed = varList.map(function(item) {
          var splits = item.split('=');
          return {
            name: splits[0].trim(),
            value: splits.length>0 ? splits[1] : 0
          }

        });

        self._createP5();
      }


    });

  </script>

</polymer-element>
